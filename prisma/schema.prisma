generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// ENUMS
// =========================

enum UserType {
  OWNER
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum AppType {
  PUBLIC
  PRIVATE
}
enum DeviceType {
  ANDROID
  IOS
  WEB
}

enum RevokeReason {
  LOGOUT
  PASSWORD_CHANGED
  ADMIN_REVOKE
}
enum DeliveryPolicy {
  OPEN
  SCHEDULED
  MANUAL
}
// =========================
// MODELS
// =========================

// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (Ø§Ù„Ù…Ø§Ù„Ùƒ + Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
model User {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())

  schoolId     Int?     @map("school_id")
  school       School?  @relation(fields: [schoolId], references: [id])

  userType     UserType @map("user_type")
  code         Int?     // (ÙÙŠ V9.3 Ù…ÙƒØªÙˆØ¨ code int unique per school â€” Ø§Ù„Ø£ÙØ¶Ù„ enforce Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù…Ø¤Ø´Ø±)
  name         String
  displayName  String?  @map("display_name")
  gender       String?

  phone        String?
  email        String?

  province        String?
  district        String?
  addressArea     String? @map("address_area")
  addressDetails  String? @map("address_details")

  passwordHash String @map("password_hash")

  isActive     Boolean @map("is_active")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  isDeleted    Boolean  @default(false) @map("is_deleted")
  deletedAt    DateTime? @map("deleted_at")

  devices      UserDevice[]
  sessions     AuthSession[]

  @@index([schoolId], map: "users_school_id_idx")
  @@index([userType], map: "users_user_type_idx")
  @@index([phone], map: "users_phone_idx")
  @@index([email], map: "users_email_idx")

  @@map("users")
}



model School {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(uuid())

  name        String
  displayName String?  // NEW (DBML: display_name)
  schoolCode  Int      @unique
  appType     AppType

  phone         String?
  email         String?
  // OLD: logoUrl String?
  logoMediaAssetId Int? // NEW (FK Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù„Ù‰ media_assets)

  address       String?
  province      String?
  district      String?
  addressArea   String?
  educationType String?

  ownerNotes String?

  nextUserCode Int @default(1)

  primaryColor    String?
  secondaryColor  String?
  backgroundColor String?

  deliveryPolicy DeliveryPolicy @default(OPEN)

  isActive  Boolean  @default(true)
  isDeleted Boolean  @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]
  authSessions AuthSession[]
}


// Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ø§Ù…
model GradeDictionary {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(uuid())

  code        String  @unique // Ù…Ø«Ù„ G01
  defaultName String  // Ù…Ø«Ù„ "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ"
  shortName   String? // Ù…Ø«Ù„ "Ø£.Ø£" Ø£Ùˆ "Ø£.Ø«"
  stage       String? // ØªÙ…Ù‡ÙŠØ¯ÙŠ/Ø£Ø³Ø§Ø³ÙŠ/Ø«Ø§Ù†ÙˆÙŠ...
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  /// ğŸ”„ Ø­Ø°Ù Ù…Ù†Ø·Ù‚ÙŠ + Ø¯Ø¹Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  isDeleted Boolean  @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù€ FCM Ù„Ø§Ø­Ù‚Ø§Ù‹)
model UserDevice {
  id                Int      @id @default(autoincrement())
  uuid              String   @unique @default(uuid())

  userId            Int      @map("user_id")
  user              User     @relation(fields: [userId], references: [id])

  deviceFingerprint String   @map("device_fingerprint")
  pushToken         String?  @map("push_token")
  deviceType        DeviceType @map("device_type")

  lastSeenAt        DateTime @map("last_seen_at")
  isActive          Boolean  @map("is_active")

  sessions          AuthSession[]

  @@unique([deviceFingerprint], map: "user_devices_device_fingerprint_key") // ÙŠØ·Ø§Ø¨Ù‚ unique
  @@unique([pushToken], map: "user_devices_push_token_key")                // ÙŠØ·Ø§Ø¨Ù‚ unique (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØºÙŠÙŠØ±Ù‡)
  @@index([userId], map: "user_devices_user_id_idx")

  @@map("user_devices")
}


model AuthSession {
  id               Int       @id @default(autoincrement())
  uuid             String    @unique @default(uuid())

  userId           Int       @map("user_id")
  user             User      @relation(fields: [userId], references: [id])

  schoolId         Int?      @map("school_id")
  school           School?   @relation(fields: [schoolId], references: [id])

  deviceId         Int?      @map("device_id")
  device           UserDevice? @relation(fields: [deviceId], references: [id])

  refreshTokenHash String    @unique @map("refresh_token_hash")

  createdAt        DateTime  @default(now()) @map("created_at")
  lastSeenAt       DateTime? @map("last_seen_at")

  expiresAt        DateTime  @map("expires_at")

  revokedAt        DateTime? @map("revoked_at")
  revokeReason     RevokeReason? @map("revoke_reason")

  @@index([userId], map: "auth_sessions_user_id_idx")
  @@index([schoolId], map: "auth_sessions_school_id_idx")
  @@index([deviceId], map: "auth_sessions_device_id_idx")
  @@index([revokedAt], map: "auth_sessions_revoked_at_idx")

  @@map("auth_sessions")
}
